{% extends "base.html" %}

{% block title %}Analytics & Chat - SFA{% endblock %}
{% block header %}Analytics & AI Assistant{% endblock %}

{% block content %}
<div class="row my-4">
    <!-- Chat Interface -->
    <div class="col-lg-5">
        <div class="bg-white shadow-sm rounded p-3">
            <h3 class="fs-5 border-bottom pb-2">AI Financial Advisor</h3>
            <div class="chat-box mb-3" id="chat-messages" style="max-height: 400px; overflow-y: auto;">
                <div class="message bot-msg">Hello! I can help you analyze financial data. Ask me anything!</div>
            </div>
            <div id="status-indicator" class="text-muted small mb-2 fst-italic" style="height: 20px;"></div>
            <div class="input-group">
                <input type="text" id="user-input" class="form-control" placeholder="Type your question...">
                <button class="btn btn-outline-secondary" onclick="requestGraph()" title="Generate Graph"><i
                        class="fas fa-chart-bar"></i></button>
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Analytics Graphs -->
    <div class="col-lg-7">
        <div class="bg-white shadow-sm rounded p-3 mb-3">
            <h3 class="fs-5 border-bottom pb-2">Revenue Trend</h3>
            <div id="revenue-chart"></div>
        </div>
        <div class="bg-white shadow-sm rounded p-3">
            <h3 class="fs-5 border-bottom pb-2">Net Income Analysis</h3>
            <div id="income-chart"></div>
        </div>
    </div>
</div>

<script>
    // Chat Logic
    let timerInterval;

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const statusDiv = document.getElementById('status-indicator');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user-msg');
        input.value = '';
        input.disabled = true; // Disable input while thinking

        // Start Timer
        let seconds = 0;
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Thinking... (0s)';
        timerInterval = setInterval(() => {
            seconds++;
            statusDiv.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Thinking... (${seconds}s)`;
        }, 1000);

        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ message })
            });
            const data = await response.json();

            clearInterval(timerInterval);
            statusDiv.textContent = `Replied in ${seconds} seconds.`;

            addMessage(data.response, 'bot-msg');
        } catch (error) {
            clearInterval(timerInterval);
            statusDiv.textContent = 'Error occurred.';
            addMessage('Error: Could not get response.', 'bot-msg');
        } finally {
            input.disabled = false;
            input.focus();
        }
    }

    function addMessage(text, className) {
        const div = document.createElement('div');
        div.className = `message ${className}`;

        // Check for Graph Data
        let content = text;
        let graphJson = null;

        if (text.includes('graph_data||')) {
            const parts = text.split('graph_data||');
            content = parts[0];
            try {
                graphJson = JSON.parse(parts[1]);
            } catch (e) {
                console.error("Failed to parse graph JSON", e);
            }
        }

        div.innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

        const chatBox = document.getElementById('chat-messages');
        chatBox.appendChild(div);

        // If graph exists, append a graph container
        if (graphJson && className === 'bot-msg') {
            const graphDiv = document.createElement('div');
            const graphId = 'chat-graph-' + Date.now();
            graphDiv.id = graphId;
            graphDiv.style.width = '100%';
            graphDiv.style.height = '300px';
            graphDiv.className = 'mt-2 mb-2 bg-light rounded';
            chatBox.appendChild(graphDiv);

            try {
                const modernLayout = {
                    font: { family: 'Inter, sans-serif', size: 12, color: '#6c757d' },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    xaxis: { gridcolor: '#e9ecef' },
                    yaxis: { gridcolor: '#e9ecef' },
                    margin: { t: 20, b: 40, l: 40, r: 20 },
                    height: 300
                };
                Plotly.newPlot(graphId, graphJson.data, { ...modernLayout, ...graphJson.layout });
            } catch (e) {
                console.error("Plotly Error", e);
                graphDiv.innerHTML = "<small class='text-danger'>Error rendering graph</small>";
            }
        }

        chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // Load Charts
    // Request Graph from AI
    async function requestGraph() {
        const input = document.getElementById('user-input');
        const message = input.value.trim();
        if (!message) {
            alert("Please type what you want to graph (e.g. 'Net Income of Apple')");
            return;
        }

        // Use the same send mechanism but could add a flag if backend supported it.
        // For now, we just send it as a message, but in a real app, we'd hit a /graph endpoint.
        // The user asked for a specific button, so let's simulate the intent.
        input.value = "Graph: " + message;
        sendMessage();
    }

    // Load Charts
    async function loadCharts() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/dashboard/metrics', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            // Common Layout Options for Modern Look
            const commonLayout = {
                font: { family: 'Inter, sans-serif', size: 12, color: '#6c757d' },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    gridcolor: '#e9ecef',
                    zeroline: false,
                    showline: true,
                    linecolor: '#dee2e6',
                    title: { text: 'Reporting Date', font: { size: 10, color: '#adb5bd' } },
                    type: 'date' // Ensure date parsing
                },
                yaxis: {
                    gridcolor: '#e9ecef',
                    zeroline: false,
                    showline: false,
                    tickprefix: '$', // Add dollar sign
                },
                margin: { t: 40, r: 20, l: 60, b: 60 },
                height: 350,
                hovermode: 'x unified',
                showlegend: false
            };

            // Helper to format large numbers for hover
            // We use Plotly's D3 formatting in hovertemplate

            // 1. Revenue Chart
            Plotly.newPlot('revenue-chart', [{
                x: data.trend.dates,
                y: data.trend.values,
                type: 'scatter',
                mode: 'lines+markers', // Add markers to see points
                name: 'Total Revenue',
                fill: 'tozeroy',
                line: { shape: 'spline', width: 3, color: '#009d63' }, // SFA Green
                fillcolor: 'rgba(0, 157, 99, 0.1)',
                hovertemplate: '<b>%{x|%b %Y}</b><br>Revenue: $%{y:,.0f}<extra></extra>' // Custom hover
            }], {
                ...commonLayout,
                title: { text: 'Total Market Revenue (USD)', font: { size: 14, color: '#333' }, x: 0.05 },
                yaxis: { ...commonLayout.yaxis, title: { text: 'Amount (USD)', font: { size: 10 } } }
            });

            // 2. Net Income Chart
            // If income_trend is missing, we shouldn't fake it with 0.8 * revenue.
            // Backend now guarantees income_trend structure, so we use it.
            const incomeDates = data.income_trend ? data.income_trend.dates : [];
            const incomeValues = data.income_trend ? data.income_trend.values : [];

            Plotly.newPlot('income-chart', [{
                x: incomeDates,
                y: incomeValues,
                type: 'bar',
                name: 'Net Income',
                marker: {
                    color: incomeValues.map(v => v >= 0 ? '#0d6efd' : '#dc3545'), // Blue for pos, Red for neg
                    opacity: 0.8,
                    line: { width: 0 }
                },
                hovertemplate: '<b>%{x|%b %Y}</b><br>Net Income: $%{y:,.0f}<extra></extra>'
            }], {
                ...commonLayout,
                title: { text: 'Total Market Net Income (USD)', font: { size: 14, color: '#333' }, x: 0.05 },
                yaxis: { ...commonLayout.yaxis, title: { text: 'Net Income (USD)', font: { size: 10 } } }
            });

        } catch (error) {
            console.error("Error loading charts:", error);
            // Show error in the chart containers
            document.getElementById('revenue-chart').innerHTML = `<p class="text-danger p-3">Failed to load data.</p>`;
            document.getElementById('income-chart').innerHTML = `<p class="text-danger p-3">Failed to load data.</p>`;
        }
    }

    loadCharts();
</script>
{% endblock %}